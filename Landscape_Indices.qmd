---
title: "Landscape Indices"
author: "Maite"
format: html
editor: visual
theme: flatly
---

This script explores how to use the ATKIS Basis-DLM data 1:50.000 for incorporating information on the landscape configuration that might be relevant for biodiversity of grasslands. I'm using the HAI exploratory's area within Thüringen for a test run (getting ATKIS for the ALB in BaWü is difficult, unfortunately).

As measure of taxonomic biodiversity, the **Shannon-Wiener index** is used (quantifies variety and evenness of species present): relative abundance of each species (number of individuals per species/total n), each species relative abundance is multiplied by its natural logarithm, all values are summed up and negative of sum taken. Higher values mean more species present and they are more evenly distributed.

Moreover, to grasp functional diversity, XXX is used as a response.

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=F, warning = F)
```

```{r}
library(here)
library(sf)
library(terra)
library(raster)
library(mapview)
library(ggplot2)
library(landscapemetrics)
library(leaflet)
library(dplyr)
library(kableExtra)
```

# Hypothesis on grassland biodiversity

Ideas on what aspects of the landscape patterns might be relevant for biodiversity of grasslands:

*how to translate into method*

[preliminary results on the hypothesis]{.underline}

**Patch metric related hypotheses:**

-   **HP1: Species Area Relationship**: larger islands, larger species richness (MacArthur, Wilson 1967)

    I.e. (higher equilibrium (immigration vs extinction) number of species) Larger areas contain greater variability of habitats -\> More niches can be satisfied. Larger areas can support larger communities which in turn are less likely to become extinct (Mittelbach 2019)

    more grassland specialists on larger patches, plant species richness increasing with patch size (Loos et al. 2021)

    -   *size of the patch/field, area of connected grassland (what is connected? road / forest / ..)*

    -   [not verified]{.underline} (n=XXX, area= XXX)

-   **HP2: Irregularly shaped patches** contain higher number of environmental gradients (Honnay 1999) and higher ratio edge length : patch size -\> higher effects of adjacent agriculture

    -   *ratio edge length : patch size*

        -   *is there a correlation between patch complexity and grassland history and LUI?*

-   **HP3: Grassland next neighbor**: Higher distance between patches leads to reduced biodiversity (reduces migration, higher extinction risk, lower recolonization probability)

    -   *nearest grassland neighbor distance*

    -   [not verified for now]{.underline}

-   **HP4: Landscape context matters for biodiversity**

    -   *percent type of land use in surroundings, especially agriculture*

-   **HP4a: Percent arable land:** the more arable land within the landscape, the less species richness on the grassland plots (Loos et al. 2021) arthropod decline for grassland associated with agriculture at landscape scale (Li 2023, Seibold 2019)

    -   *percent arable land within landscape*

    -   [not verified for now (n=xxx, area=xxx, ...)]{.underline}

-   (?) Availability of **hedges** (Fukamachi et al. 2011, Cherrill et al. 2010)

**Landscape history related hypotheses:**

-   ***Historical*** **patch size and isolation:** Current isolation differs strongly from the isolation which occurred when the species richness was formed, because many grasslands disappeared. The extinction of species in response to isolation might be delayed by 100 years or more (extinction debt). Thus, historical isolation might be more important in describing current diversity than recent isolation.Lindborg & Eriksson (2004) Pärtel et al. (2005)

    -   probably only for discussion

-   Older patches show higher biodiversity, younger patches have higher nutrient levels if used as agricultural land before (Honnay 1999)

    -   *Grassland history from time series (???) e.g. via NDVI time series with breaking points?*

**Disturbance related hypothesis:**

-   **HD1: Intermediate Disturbance Hypothesis**:\
    Species Richness highest when moderate disturbance intensity (grazing/mowing) because grazing/mowing have disproportional large effect on competitive dominants, gaps are produced where proagules can establish (Fox 1979, Leps 1999)

    -   *LUI (germany wide)*

    -   intermediate LUI and its components lead to highest biodiversity

    -   [not verified for LUI (n=xxx, area=xxx), but for mowing (n=xxx, area=xxx, sig=xxx)]{.underline}

-   **HD2: enhanced productivity** **-\> reduction in diversity**; fertilization amplifies differences between relative growth rates of neighboring ramets, high nutrient adapted plants will out compete others (Pärtel 2002, Sammul 2003) **LU intensification** --\> species loss, adverse effects on dietary specialists, promoting generalist species, homogenized assemblages (Christe 2018) Land use intensification, fertilization -\> reduction of grassland biodiversity: Severe declines in plant species richness have been especially caused by intensive fertilization (Gross 2009; Socher 2012) such that even common plant species have decreased in abundance at alarming rates (Jansen 2019). (Freitag et al. 2021)

    -   *fertilization data / LUI; Poductivity proxy NDVI*

-   **HD3: Inter-annual variation in land use intensity** enhances grassland multidiversity (Allan 2014) especially in rarer species

    -   *LUI temporal variability*

    -   [not verified for now (xxx)]{.underline}

**Abiotic habitat related hypotheses:**

-   **HA1: Habitat heterogeneity hypothesis**: Abiotic diversity creates different niches --\> higher species richness (Burnett 2008, Heidrich 2020)

    probably only important to compare between explos, perhaps Zeigerwerte model analysis / discussion

    -   *SD abiotic predictors (terrain, ...) in environment*

-   **HA2: Soil properties are relevant for grassland biodiversity**

    -   *soil type, bedrock, distance to groundwater, soil texture...*

-   **HA2a: High pH, higher species richness**: were more abundant during evolutionary times at high latitudes (Pärtel 2002)

    -   *pH*

-   **HA2b: Soil depth** effects on grassland communities and landuse practices interact: Soil depth had a strong positive effect on species richness under mowing, suggesting increased space for niche differentiation in deeper soils. In unmown plots, deep soils harboured a similar diversity of species as shallow soils, and our findings suggest that this effect on diversity is due to larger biomass and lower light availability on deep soils. Fertilization and trampling had no effect on diversity. (Braun 2022) 

    -   *soil depth, mowing frequency*

```{r}
#| results: 'hide'
#| fig.keep: 'all'
dp <- "../data/"
sap <- here(dp, "/studyarea")
geo_exp <- st_read(here(sap, "all3explos.gpkg"))
plots_exp <- st_read(here(sap, "experiementalplots.gpkg"))
lsc_all <- st_read(here(sap, "landscape_all.gpkg"))
```

```{r eval=F, warning=FALSE}
#| eval: false
#| warning: false

# projecting and cropping DLM data 
dlm_th <- st_read(here("../data/Basisdaten/DLM/Thueringen/orig/veg01_f.shp"))
dlm_th <- st_transform(dlm_th, crs(lsc_all))
dlm_th_lsc <- st_intersection(lsc_all[2,], dlm_th)
st_write(dlm_th_lsc, here("../data/Basisdaten/DLM/Thueringen/changed/veg01_f_proj_cut.shp"), append=F)
```

```{r}
#| results: 'hide'
#| fig.keep: 'all'
dlm_th <- st_read(here("../data/Basisdaten/DLM/Thueringen/changed/veg01_f_proj_cut.shp"))
dlm_th <- st_intersection(geo_exp[2,], dlm_th)
dlm_th_grass <- dlm_th[dlm_th$VEG=="1020",]
```

##### Unify adjacent grassland patches

```{r}
dlm_th_grass_unif <- st_cast(st_union(dlm_th_grass), "POLYGON")
# we loose information from ATKIS, but that shouldn't be necessary anyway, right? 
dlm_th_grass_unif <- st_sf(dlm_th_grass_unif)
```

### HP1: Grassland patch size

##### calculate grassland area around patch

```{r}
#| results: 'hide'
#| fig.keep: 'all'

d_geo <- st_read(paste0(dp, "16826_4.gpkg"))
has_plot <- st_contains(dlm_th_grass_unif, d_geo)
has_plot <- unlist(as.character(has_plot))
has_plot[has_plot == "integer(0)"] <- NA
dlm_th_grass_unif$has_plot <- !is.na(has_plot)
grass_plot <- dlm_th_grass_unif[dlm_th_grass_unif$has_plot == TRUE,]
grass_plot$grassl_area <- st_area(grass_plot)
plots_grass_HAI <- st_intersection(grass_plot, d_geo[d_geo$explrtr == "HAI" & d_geo$type == "grassland",])

```

The following map shows

-   Which grassland geometries contain exploratory plots

-   What is the grassland area that surrounds the plots

```{r}
hasplot_cols <- c("#139404", "#a0d49a")
m <- mapview(dlm_th_grass_unif, 
        col.regions=hasplot_cols, 
        map.types = "Esri.WorldImagery",
        layer.name="has explo plot")+
  mapview(dlm_th_grass, 
        color="#0b5802", 
        col.regions="#0b5802",
        alpha.regions=0,
        layer.name="lots")+
  mapview(plots_grass_HAI, 
          zcol="grassl_area",
          layer.name="srndg grssl area")
crds <- c(10.38, 51.221)
m@map %>% setView(crds[1], crds[2], zoom = 12)
```

Just checking: But as anticipated, there is, on its own, no clear relationship between the grassland area and biodiversity (only from 2013, though, at the time):

```{r}
#| layout-ncol: 2

plots_grass_HAI$gl_area <- as.numeric(plots_grass_HAI$grassl_area)
ggplot(plots_grass_HAI, aes(shannon, log(gl_area))) +
  geom_point()+
    ggtitle("grassland area x biodiversity", subtitle=paste0("HAI, n=", nrow(plots_grass_HAI)))+theme_minimal()+
  xlab("surrounding grassland area (log / m²)")+ ylab("shannon index")+
  geom_smooth(formula= y~x)

ggplot(plots_grass_HAI, aes(shannon, log(gl_area))) +
  geom_point()+
    ggtitle("grassland area x biodiversity", subtitle=paste0("HAI, n=", nrow(plots_grass_HAI)))+theme_minimal()+  xlab("surrounding grassland area (log / m²)")+ ylab("shannon index")+
  geom_smooth(formula= y~x, method="lm")
```

&rarr; HP1: could be, no major evidence, though, from HAI.

### Land use **composition within surroundings**

##### Calculate proportion of other DLM types

Looking into the proportion of DLM types within a buffer of radius 500m² surrounding the patch:

```{r, eval=F}
#| eval: false
#| warning: false
library(tools)

######### preparing a mostly overlap free version of DLM polygons ##############
# read in full DLM 
# projecting and cropping DLM data 
substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}
dlm_files <- list.files(here("../data/Basisdaten/DLM/Thueringen/orig/"), 
                        pattern=".shp", full.names=T)
dlm_files_names <- list.files(here("../data/Basisdaten/DLM/Thueringen/orig/"), 
                        pattern=".shp", full.names=F)
# group by type and use only f (l?)
dlm_files_f <- dlm_files[substrRight(substring(dlm_files_names, 1, 7), 1) == "f"]
dlm_files_use <- dlm_files_f[4:length(dlm_files_f)] # not using geb category (these are only Verwaltungseinheiten)
full_dlm_th <- lapply(seq(dlm_files_use), function(i){
  st_read(dlm_files_use[i])
})

# crop before transforming to make it go faster
HAItemplate <- st_transform(geo_exp[2,], crs(full_dlm_th[[1]]))
full_dlm_th_exp <- lapply(X = full_dlm_th, FUN = st_intersection, y = HAItemplate)
full_dlm_th_exp_transf <- lapply(X = full_dlm_th_exp, FUN = st_transform, crs = crs(geo_exp))
names(full_dlm_th_exp_transf) <- substrRight(file_path_sans_ext(dlm_files_use), 7)


# keep only OBJART & OBJART_TXT to be able to put them all together
full_dlm_th_exp_transf_subs <- lapply(seq(full_dlm_th_exp_transf), function(i){
  subs <- full_dlm_th_exp_transf[[i]][,c(1, 3, 4, 10)]
  if(nrow(subs) > 0 ){
      names(subs)[4] <- "add_info"
      subs$nam <- names(full_dlm_th_exp_transf[i])
      print(i)
      subs
  } 
})
full_dlm_th <- do.call(rbind, full_dlm_th_exp_transf_subs)
st_write(full_dlm_th,here("../data/Basisdaten/DLM/Thueringen/changed/full_DLM_f_exploHAI.gpkg"))
```

```{r}
#| results: 'hide'
dlm <- st_read(here("../data/Basisdaten/DLM/Thueringen/changed/full_DLM_f_exploHAI.gpkg"))

# unique(dlm$add_info[dlm$OBJART_TXT == "AX_Landwirtschaft"]) # which vegetation sub categories available
dlm$veg_info <- NA
dlm$veg_info[dlm$OBJART_TXT == "AX_Landwirtschaft" & dlm$add_info == "1020"] <- "grassland"
dlm$veg_info[dlm$OBJART_TXT == "AX_Landwirtschaft" & dlm$add_info == "1021"] <- "meadow_orchard"
dlm$veg_info[dlm$OBJART_TXT == "AX_Landwirtschaft" & dlm$add_info == "1010"] <- "arable_land"
dlm$veg_info[dlm$OBJART_TXT == "AX_Landwirtschaft" & dlm$add_info == "1050"] <- "orchard"
dlm$veg_info[dlm$OBJART_TXT == "AX_Landwirtschaft" & dlm$add_info == "1030"] <- "horticultural_land"
dlm$veg_info[dlm$OBJART_TXT == "AX_Landwirtschaft" & dlm$add_info == "1031"] <- "nursery"
dlm$veg_info[dlm$OBJART_TXT == "AX_Landwirtschaft" & dlm$add_info == "1011"] <- "orchard_field"

# veg04_f seems to be not that useful as "vegetationsmerkmal" overlapping other 
# categories
dlm <- dlm[dlm$nam!="veg04_f",]

# creating relevant info column for the categories that are probably interesting to us
dlm$rel_info <- dlm$OBJART_TXT
dlm$rel_info[dlm$nam=="veg01_f"] <- dlm$veg_info[dlm$nam=="veg01_f"] # adding more veg info

# make relevant color scheme 
dlm$colornam <- dlm$nam #using the layer names (general categories like siedlung / verkehr) to start for the less relevant main categories

dlm$colornam[dlm$OBJART_TXT == "AX_Landwirtschaft"] <- dlm$rel_info[dlm$OBJART_TXT == "AX_Landwirtschaft"] # use more veg info 
dlm$colornam[dlm$colornam=="veg02_f"] <- "forest"
dlm$rel_cat <- dlm$colornam

dlmcols <- c("#1050D6", "#5378C5", 
             "#9C7E6A", 
             "#E56290", "#BE5077", "#E68FAE", 
             # 10 vegetation categories
             "#B4E395","#C15208", "#11973C", "#499862", "#E4884B", "#33593F", "#4F715A", "#52AB17",
             "#37740E", "#52AB17", 
             "#C5D0C9", "#727272", "#F4F5F0", "#1F1F1F")
dlmcolnams <- unique(dlm$colornam)
dlmcolnams[is.na(dlmcolnams)] <- "other_agric"


coldf <- data.frame(colors=dlmcols, colornames = dlmcolnams)

# add colors to to dlm
dlm <- merge(dlm, coldf, by.x="colornam", by.y="colornames")

nam_rel_info_lookup <- unique(st_drop_geometry(dlm[ , c("rel_cat", "nam", "rel_info", "colors")]))

ggplot(dlm, aes(x=reorder(rel_cat, rel_cat, function(x)-length(x)), 
                fill=colornam)) +
  geom_bar()+ xlab("ATKIS category")+
  ggtitle("total amount of ATKIS categories in explo area HEG")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_fill_manual(values=unique(dlm$colors))

st_write(dlm,here("../data/Basisdaten/DLM/Thueringen/changed/full_DLM_f_relcat_exploHAI.gpkg"), append=F)
```

Work on the categories:

-   remove rel01_f? is it relevant for other areas?

-   separate stehendes Gewässer and Fließgewässer (in gew01_f)

-   make something like Teilversiegelt & Versiegelt from sie01 and sie02

-   join categories in veg01? e.g. orchards and nursery? Not so sure that would be a good idea... (?)

-   what about Sumpf?

-   Add Gehölz to Wald?

-   Verkehr komplett zu versiegelte Fläche

```{r}
# show categories and legend
lookup_ordered <- nam_rel_info_lookup[order(nam_rel_info_lookup$nam),] 

lookup_ordered %>% kbl() %>% 
  kable_paper(full_width = T) %>% 
  column_spec(5, color = "white",
              background = lookup_ordered$colors,
              popover = paste("am:", mtcars$am[1:8]))
```

Make a buffer of radius = 500m², i.e. 196.350m² around explo plots and take a look at proportions of DLM inside the buffer. Veg04 (Vegetationsmerkmale) was eliminated since it caused overlapping.

rel = relief (Felsen / Felsblock)

https://www.adv-online.de/icc/extdeu/nav/a63/binarywriterservlet%3FimgUid%3D9201016e-7efa-8461-e336-b6951fa2e0c9%26uBasVariant%3D11111111-1111-1111-1111-111111111111

Vegetation categories are as follows:

![](ATKIS_vegetation.png)

```{r}
#| warning: false
#| results: hide

dlm <- st_read(here("../data/Basisdaten/DLM/Thueringen/changed/full_DLM_f_relcat_exploHAI.gpkg"))

# crop DLM to buffer
buf <- st_buffer(plots_grass_HAI, 500)
dlm_buf <- st_intersection(dlm, buf)
# dlm_grouped_buf <- dlm_buf %>% group_by(GpPlotID)
dlm_grouped_buf <- dlm_buf %>% group_by(ep)
dlm_grouped_buf$gi <- dlm_grouped_buf %>% group_indices()
tab <- dlm_grouped_buf %>% tally() # counting how many landscape types per buffer

# group by relevant landscape types 
landtype_sum <- lapply(seq(n_groups(dlm_grouped_buf)), function(i){
  b <- dlm_grouped_buf[dlm_grouped_buf$gi == i,] # pick one buffer
  bsum <- b %>% group_by(rel_cat, nam, colors, colornam) %>% summarise()
  bsum$ep <- unique(b$ep)
  bsum$area <- st_area(bsum)
  bsum$areanum <- as.numeric(st_area(bsum))
  bsum$areak <- bsum$areanum/1e+06
  bsum
})
```

```{r}
crds <- c(10.339, 51.118)
m2 <- mapview(dlm, zcol="colornam", 
        col.regions=dlm$colors)+
  mapview(plots_grass_HAI)+
  mapview(buf)
m2@map %>% setView(crds[1], crds[2], zoom = 12)

```

##### exemplary plots

Maybe sum up Gehölz and Wald into one category? Take a look at northern plot for this...

```{r}
bufvec <- c(28, 19, 1, 3, 38)

lapply(seq(bufvec), function(i){
  data <- landtype_sum[[i]]
  
  plotcall <- ggplot(data, aes(y=areanum, x=rel_cat, fill=rel_cat))+
  geom_bar(stat="identity")+
  xlab("ATKIS category")+ylab("area within 500m² buffer around plot (km²)")+
  ggtitle(data$ep)+
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_fill_manual(values=data$colors)
  
  
  plotcall
})


```

```{r}
maplist <- lapply(seq(bufvec), function(i){
  data <- landtype_sum[[i]]
  
  mapcall <- mapview(data, zcol="colornam",
        col.regions=data$colors,
        layer.name="ATKIS category", 
        map.types = "Esri.WorldImagery",
        legend=FALSE)
  
  mapcall
})

maplist[[1]]
maplist[[2]]
maplist[[3]]
maplist[[4]]
maplist[[5]]

```

Biodiversity and land use composition in the surrounding buffer:

```{r}
ex <- landtype_sum[[19]]
ntypes <- dim(ex)[1]

# for all buffers: what's the correlation between biodiversity and the amount of different land uses in the buffer? 
shan_buf <- sapply(seq(landtype_sum), function(i){
  d_geo$shannon[d_geo$ep == unique(landtype_sum[[i]]$ep)]
})

# simply counting the amount of different landuse types within buffer 
ntypes <- lapply(landtype_sum, dim)
ntypes_dlm <- sapply(ntypes, `[[`, 1)

# what's the category of highest proportion?


nam_rel_info_lookup_unique_cat <- 
  nam_rel_info_lookup[!duplicated(nam_rel_info_lookup[,c('rel_cat')]),]


props <- lapply(seq(landtype_sum), function(i){
  areaprop <- st_area(landtype_sum[[i]])/sum(st_area(landtype_sum[[i]]))
  prd <- data.frame(rel_cat = landtype_sum[[i]]$rel_cat, area_prop = areaprop)
  propdf <- merge(prd, nam_rel_info_lookup_unique_cat, by="rel_cat", all.y=F)
  
  maxprop <- propdf$rel_cat[which(propdf$area_prop == max(propdf$area_prop))]
  p_ar <- as.numeric(propdf$area_prop[propdf$rel_cat == "arable_land"])
  p_gr <- as.numeric(propdf$area_prop[propdf$rel_cat == "grassland"])
  p_fo <- as.numeric(propdf$area_prop[propdf$rel_cat == "forest"])
  p_cnst <- as.numeric(sum(propdf$area_prop[propdf$rel_cat == c("sie01_f", "sie02_f", "sie03_f", "ver01_f", 
                                                 "ver02_f", "ver03_f", "ver04_f", "ver06_f")]))

  return(list(maxprop, propdf, p_ar, p_gr, p_fo, p_cnst))
})

maxprop <- sapply(props, `[[`, 1)

dlmtypes <- data.frame(shannon = unlist(shan_buf), 
                       n_dlm_types = ntypes_dlm,
                       maxprop = maxprop)

dlmtypes <- merge(dlmtypes, lookup_ordered, by.x="maxprop", by.y="rel_cat")
drops <- c("nam", "rel_info")
dlmtypes <- dlmtypes[,!(names(dlmtypes) %in% drops)]

dlmtypes$maxprop[ grepl("Wald", dlmtypes$maxprop) ] <- "forest"


ggplot(dlmtypes, aes(n_dlm_types, shannon, color=maxprop)) +
  geom_point(size=2)+
  ggtitle("DLM types within buffer x biodiversity")+
  xlab("amount of dlm types in buffer")+ ylab("shannon index")+
  scale_color_manual("maximum proportion", values=unique(dlmtypes$colors))

ggplot(dlmtypes, aes(n_dlm_types, shannon, group=n_dlm_types)) +
  geom_boxplot()+
    ggtitle("DLM types within buffer x biodiversity")+
  xlab("amount of dlm types in buffer")+ ylab("shannon index")

ggplot(dlmtypes, aes(maxprop, shannon, group=maxprop, color=maxprop)) +
  geom_boxplot()+
  ggtitle("maximum proportion DLM types within buffer x biodiversity")+
  xlab("dlm type with most area representation in buffer")+ ylab("shannon index")+
  scale_color_manual("maximum proportion", values=unique(dlmtypes$colors))


propdf <- lapply(props, `[[`, 2)

p_ar <- sapply(props, `[[`, 3)
p_ar[sapply(p_ar, length) == 0] <- NA
dlmtypes$p_ar <- unlist(p_ar)

p_gr <- sapply(props, `[[`, 4)
p_gr[sapply(p_gr, length) == 0] <- NA
dlmtypes$p_gr <- unlist(p_gr)

p_fo <- sapply(props, `[[`, 5)
p_fo[sapply(p_fo, length) == 0] <- NA
dlmtypes$p_fo <- unlist(p_fo)

p_cnst <- sapply(props, `[[`, 6)
p_cnst[sapply(p_cnst, length) == 0] <- NA
dlmtypes$p_cnst <- unlist(p_cnst)



ggplot(dlmtypes, aes(p_ar, shannon)) +
  geom_point(size=2)+
  ggtitle("percent arable land within buffer x biodiversity")+
  xlab("percent arable land within buffer")+ ylab("shannon index")+
  geom_smooth(formula= y~x)

ggplot(dlmtypes, aes(p_gr, shannon)) +
  geom_point(size=2)+
  ggtitle("percent grassland within buffer x biodiversity")+
  xlab("percent grassland within buffer")+ ylab("shannon index")+
  geom_smooth(formula= y~x)

```

## Patch metrics

```{r}
#| warning: false
#| results: hide
#| 
pm_vec <- st_read(paste0(here("../data/Basisdaten/DLM/Thueringen/changed/pm_vec.gpkg")))

d_geo_patch <- st_intersection(d_geo, pm_vec)
```

```{r}
#| layout-ncol: 2

# area: patch area
# cai: Core Area Index; percentage of a patch that is core area
# enn: euclidean nearest neighbour distance
# frac: standardized patch complexity (~perimeter:size)
# frac = 1 for a squared patch shape form and frac = 2 for a irregular patch shape


ggplot(d_geo_patch, aes(area, shannon))+
  geom_point()+
  geom_smooth(span=2)+
  theme_minimal()+
  ggtitle("patch area x biodiversity", subtitle = paste0("n = ", nrow(d_geo_patch)))

ggplot(d_geo_patch, aes(enn, shannon))+
  geom_point()+
  geom_smooth(span=2)+
  theme_minimal()+
  ggtitle("euclidean nearest neighbour distance x biodiversity", subtitle = paste0("n = ", nrow(d_geo_patch)))

ggplot(d_geo_patch, aes(frac, shannon))+
  geom_point()+
  geom_smooth(span=2)+
  theme_minimal()+
  ggtitle("standardized patch complexity x biodiversity", subtitle = paste0("n = ", nrow(d_geo_patch)))

ggplot(d_geo_patch, aes(cai, shannon))+
  geom_point()+
  geom_smooth(span=2)+
  theme_minimal()+
  ggtitle("core area index x biodiversity", subtitle = paste0("n = ", nrow(d_geo_patch)))


names(d_geo)

```

### **Patch shape, Patch complexity, distances between patches** 

See calc_patch_metrics scripts trying landscapemetrics package and RS Github Repo

```{r}
lui <- read.csv(list.files(here("../data/LUI/LuiData/"), pattern=".txt$", full.names=T))

# fix some things in LUI dataset to merge correctly 
lui$year <- substring(lui$YEAR, 12,15)

idshort <- lui$PLOTID[nchar(lui$PLOTID) == 4] 
idshortfix <- paste0(substring(idshort, 1,3), "0", substring(idshort, 4,4))
lui$PLOTID[nchar(lui$PLOTID) == 4]  <- idshortfix


lui13 <- filter(lui, year=="2013")
d_lui <- merge(d_geo, lui13, by.x="ep", by.y="PLOTID")
# table(d_lui$year) # now all 150plots are merged 

ggplot(d_lui, aes(LUI, shannon))+
  geom_point()+
  geom_smooth(span=2)+
  theme_minimal()+
  ggtitle("LUI x biodiversity", subtitle = paste0("n = ", nrow(d_lui[d_lui$year == "2013",])))

```

```{r}
#| layout-ncol: 3
ggplot(d_lui, aes(G_STD, shannon))+
  geom_point()+
  geom_smooth(span=2)+
  theme_minimal()+
  ggtitle("grazing x biodiversity", subtitle = paste0("n = ", nrow(d_lui[d_lui$year == "2013",])))

ggplot(d_lui, aes(y=shannon, x=M_STD))+
  geom_boxplot(aes(group=M_STD))+
  theme_minimal()+
  ggtitle("mowing x biodiversity", subtitle = paste0("n = ", nrow(d_lui[d_lui$year == "2013",])))

ggplot(d_lui, aes(F_STD, shannon))+
  geom_point()+
  geom_smooth(span=2)+
  theme_minimal()+
  ggtitle("fertilization x biodiversity", subtitle = paste0("n = ", nrow(d_lui[d_lui$year == "2013",])))
```

There seems to be a statistical relation but at least for 2013 it seems like the smaller the LUI the higher the diversity or even like intermediate disturbances lead to lowest biodiversity...

Hypothesis of highest biodiversity with intermediate disturbances seems to be valid only for grazing (which makes sense given the further explanation of the H),

### Overall correlations within the dataset and with predictors (terrain, ...)

```         
```

## Sources:

https://gistbok.ucgis.org/bok-topics/landscape-metrics#:\~:text=Landscape%20metrics%E2%80%94also%20known%20as,within%20a%20defined%20geographic%20area.

# to do:

Fließgewässer, stehende trennen, sonst versiegelte Fläche zusammenfassen
